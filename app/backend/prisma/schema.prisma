generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String          @id @default(uuid()) @db.Uuid
  firebaseUid     String          @unique @map("firebase_uid")
  email           String          @unique
  displayName     String?         @map("display_name")
  timezone        String          @default("UTC")
  coachStyle      CoachStyle      @default(SUPPORTIVE) @map("coach_style")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  aiInsights      AIInsight[]
  aiUsageLogs     AIUsageLog[]
  aiUsageStats    AIUsageStats[]
  dailyStats      DailyStats[]
  habitEvents     HabitEvent[]
  habits          Habit[]
  journalEntries  JournalEntry[]
  weeklySummaries WeeklySummary[]

  @@map("users")
}

model Habit {
  id          String       @id @default(uuid()) @db.Uuid
  userId      String       @map("user_id") @db.Uuid
  title       String
  description String?
  habitType   HabitType    @map("habit_type")
  isActive    Boolean      @default(true) @map("is_active")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  habitEvents HabitEvent[]
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("habits")
}

model HabitEvent {
  id         String    @id @default(uuid()) @db.Uuid
  userId     String    @map("user_id") @db.Uuid
  habitId    String    @map("habit_id") @db.Uuid
  eventType  EventType @map("event_type")
  notes      String?
  occurredAt DateTime  @map("occurred_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  habit      Habit     @relation(fields: [habitId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, habitId])
  @@index([occurredAt])
  @@map("habit_events")
}

model JournalEntry {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  title      String?
  content    String
  moodRating Int?     @map("mood_rating")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("journal_entries")
}

model AIInsight {
  id          String      @id @default(uuid()) @db.Uuid
  userId      String      @map("user_id") @db.Uuid
  insightType InsightType @map("insight_type")
  title       String
  content     String
  dataUsed    Json?       @map("data_used")
  wasShown    Boolean     @default(false) @map("was_shown")
  shownAt     DateTime?   @map("shown_at")
  createdAt   DateTime    @default(now()) @map("created_at")
  expiresAt   DateTime?   @map("expires_at")
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([insightType])
  @@index([createdAt])
  @@map("ai_insights")
}

model DailyStats {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  date            DateTime @db.Date
  habitsCompleted Int      @default(0) @map("habits_completed")
  habitsTotal     Int      @default(0) @map("habits_total")
  journalEntries  Int      @default(0) @map("journal_entries")
  avgMood         Float?   @map("avg_mood")
  createdAt       DateTime @default(now()) @map("created_at")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date], name: "user_date_unique")
  @@index([userId])
  @@index([date])
  @@map("daily_stats")
}

model AIUsageStats {
  id            String   @id @default(uuid()) @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  month         String
  totalRequests Int      @default(0) @map("total_requests")
  totalTokens   Int      @default(0) @map("total_tokens")
  totalCost     Float    @default(0) @map("total_cost")
  lastUpdated   DateTime @default(now()) @map("last_updated")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month], name: "user_month_unique")
  @@index([userId])
  @@index([month])
  @@map("ai_usage_stats")
}

model AIUsageLog {
  id               String   @id @default(uuid()) @db.Uuid
  userId           String   @map("user_id") @db.Uuid
  model            String
  promptTokens     Int      @map("prompt_tokens")
  completionTokens Int      @map("completion_tokens")
  totalTokens      Int      @map("total_tokens")
  cost             Float
  createdAt        DateTime @default(now()) @map("created_at")
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("ai_usage_logs")
}

model WeeklySummary {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  weekStart       String   @map("week_start")
  weekEnd         String   @map("week_end")
  aiSummary       String   @map("ai_summary")
  statistics      Json
  achievements    Json
  insights        Json
  recommendations Json
  moodAnalysis    Json     @map("mood_analysis")
  habitAnalysis   Json     @map("habit_analysis")
  comparison      Json?
  predictions     Json?
  createdAt       DateTime @default(now()) @map("created_at")
  expiresAt       DateTime @map("expires_at")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, weekStart], name: "user_week_unique")
  @@index([userId])
  @@index([weekStart])
  @@map("weekly_summaries")
}

enum CoachStyle {
  SUPPORTIVE   @map("supportive")
  DIRECT       @map("direct")
  MOTIVATIONAL @map("motivational")
}

enum HabitType {
  AVOID @map("avoid")
  BUILD @map("build")
}

enum EventType {
  COMPLETED @map("completed")
  SKIPPED   @map("skipped")
  RELAPSED  @map("relapsed")
}

enum InsightType {
  WEEKLY_SUMMARY   @map("weekly_summary")
  DAILY_TIP        @map("daily_tip")
  PATTERN_DETECTED @map("pattern_detected")
}
